apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cleanup-examples
spec:
  rules:
  # Cleans up Deployments and Statefulsets without the label `application` at midnight every day.
  - name: cleanup-deploys-no-labels
    match:
      all:
      - resources:
          kinds:
          - Deployment
          - StatefulSet
    exclude:
      all:
      - resources:
          selector:
            matchLabels:
              application: "?*"
    cleanup:
      schedule: "0 0 * * *"
      conditions: {}
  # Cleans up any bare Pods every 5 days
  - name: cleanup-deploys-no-labels
    match:
      any:
      - resources:
          kinds:
          - Pod
    cleanup:
      schedule: "0 0 */5 * *"
      conditions:
        all:
        - key: "{{ target.metadata.ownerReferences[] || `[]` }}"
          operator: Equals
          value: []
  # Clean up all resources in the `foo` Namespace on the first of every month
  - name: cleanup-everything-in-foo
    match:
      any:
      - resources:
          kinds:
          - "*"
          namespaces:
          - foo
    cleanup:
      schedule: "0 * 1 * *"
      conditions: {}
  # Cleans up unbound PVCs every Sunday at 07:00
  - name: cleanup-unbound-pvcs
    match:
      any:
      - resources:
          kinds:
          - PersistentVolumeClaims
    # context:
    # - name: allpvcs
    #   apiCall:
    #     urlPath: "/api/v1/persistentvolumeclaims"
    #     jmesPath: "items[?status.phase == 'Unbound'] || `[]`"
    # preconditions:
    #   all:
    #   - key: "{{allpvcs}}"
    #     operator: NotEquals
    #     value: []
    cleanup:
      schedule: "0 7 * * 0"
      conditions:
        all:
        - key: "{{target.status.phase}}"
          operator: Equals
          value: Unbound
